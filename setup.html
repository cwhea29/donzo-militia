<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Donzo Militia ‚Äî Setup</title>
<link rel="icon" href="DM_2.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --g:#4e6443;--gl:#6a8a5a;--gd:#2e3d27;--gg:rgba(78,100,67,0.35);
  --gold:#c9a84c;--red:#c0392b;--dk:#080c07;--p:#0d1209;--p2:#131a0f;--p3:#1a2414;
  --b:#2a3824;--bb:#4e6443;--tx:#c8d4c0;--txd:#8a9a80;--mt:#5a6e52;
  --ff:'Bebas Neue',sans-serif;--fb:'Oswald',sans-serif;--fm:'Share Tech Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--fb);background:radial-gradient(ellipse at center,#0d1a09,#050805 70%);color:var(--tx);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(78,100,67,.07) 1px,transparent 1px),linear-gradient(90deg,rgba(78,100,67,.07) 1px,transparent 1px);
  background-size:44px 44px;pointer-events:none;animation:gp 5s ease-in-out infinite;}
@keyframes gp{0%,100%{opacity:.4;}50%{opacity:1;}}

.wrap{position:relative;z-index:1;max-width:700px;margin:0 auto;padding:40px 20px 80px;}

/* header */
.setup-header{display:flex;align-items:center;gap:16px;margin-bottom:40px;}
.setup-logo{width:60px;height:60px;object-fit:contain;filter:drop-shadow(0 0 10px rgba(78,100,67,.6));}
.setup-brand{flex:1;}
.setup-org{font-family:var(--ff);font-size:34px;letter-spacing:4px;color:var(--gl);text-shadow:0 0 20px var(--gg);line-height:1;}
.setup-sub{font-family:var(--fm);font-size:10px;letter-spacing:4px;color:var(--mt);margin-top:3px;}

/* progress */
.progress{display:flex;gap:0;margin-bottom:36px;}
.step-dot{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative;}
.step-dot::before{content:'';position:absolute;top:14px;left:50%;right:-50%;height:2px;background:var(--b);z-index:0;}
.step-dot:last-child::before{display:none;}
.step-dot.done::before{background:var(--g);}
.dot-circle{width:28px;height:28px;border-radius:50%;border:2px solid var(--b);background:var(--p);
  display:flex;align-items:center;justify-content:center;font-family:var(--fm);font-size:11px;
  color:var(--mt);position:relative;z-index:1;transition:all .3s;}
.step-dot.active .dot-circle{border-color:var(--g);background:var(--g);color:#fff;}
.step-dot.done .dot-circle{border-color:var(--g);background:var(--g);color:#fff;}
.dot-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--mt);font-family:var(--fm);text-align:center;}
.step-dot.active .dot-label{color:var(--gl);}

/* panels */
.panel{background:linear-gradient(160deg,#0f1a0a,#080c07);border:1px solid var(--bb);padding:28px 30px;display:none;animation:fadein .3s ease;}
.panel.active{display:block;}
@keyframes fadein{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.panel-title{font-family:var(--ff);font-size:26px;letter-spacing:3px;color:var(--gl);margin-bottom:6px;}
.panel-desc{font-size:14px;color:var(--txd);line-height:1.6;margin-bottom:24px;}

label{display:block;font-size:10px;letter-spacing:4px;text-transform:uppercase;color:var(--mt);margin-bottom:6px;font-family:var(--fm);}
input,textarea,select{width:100%;padding:10px 13px;background:rgba(0,0,0,0.4);border:1px solid var(--b);
  border-left:3px solid var(--g);color:var(--tx);font-family:var(--fm);font-size:13px;outline:none;transition:all .2s;margin-bottom:14px;}
input:focus,textarea:focus{border-color:var(--gl);box-shadow:0 0 0 1px rgba(78,100,67,0.2);}
textarea{min-height:120px;resize:vertical;font-size:12px;}
select option{background:var(--p2);}
.hint{font-size:10px;color:var(--mt);letter-spacing:1px;margin-top:-10px;margin-bottom:14px;font-family:var(--fm);}

.btn-row{display:flex;gap:10px;margin-top:20px;}
.btn{padding:12px 24px;cursor:pointer;font-family:var(--ff);font-size:18px;letter-spacing:3px;transition:all .2s;border:none;}
.btn-primary{background:linear-gradient(135deg,var(--g),var(--gd));border:1px solid var(--gl);color:#fff;}
.btn-primary:hover{background:linear-gradient(135deg,var(--gl),var(--g));}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}
.btn-ghost{background:none;border:1px solid var(--b);color:var(--mt);font-size:14px;letter-spacing:2px;padding:11px 18px;}
.btn-ghost:hover{border-color:var(--red);color:var(--red);}

/* status */
.status-box{padding:12px 16px;margin:16px 0;font-family:var(--fm);font-size:12px;letter-spacing:1px;border:1px solid;display:none;}
.status-box.ok{border-color:var(--g);color:var(--gl);background:rgba(78,100,67,0.08);}
.status-box.err{border-color:var(--red);color:#e05050;background:rgba(192,57,43,0.08);}
.status-box.info{border-color:var(--b);color:var(--mt);background:rgba(0,0,0,0.2);}
.status-box.show{display:block;}

/* instructions */
.inst-box{background:rgba(0,0,0,0.3);border:1px solid var(--b);padding:20px 22px;margin-bottom:20px;}
.inst-step{display:flex;gap:12px;align-items:flex-start;margin-bottom:14px;}
.inst-step:last-child{margin-bottom:0;}
.inst-n{flex-shrink:0;width:24px;height:24px;background:var(--g);color:#fff;display:flex;align-items:center;justify-content:center;font-family:var(--ff);font-size:14px;margin-top:1px;}
.inst-t{font-size:13px;color:var(--txd);line-height:1.6;}
.inst-t strong{color:var(--tx);}
.inst-t a{color:var(--gl);}
.inst-t code{color:var(--gl);font-family:var(--fm);font-size:12px;background:rgba(78,100,67,0.1);padding:1px 5px;}

/* field groups */
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

/* paste area instructions */
.paste-hint{background:rgba(78,100,67,0.06);border:1px solid var(--g);padding:14px 16px;margin-bottom:18px;font-family:var(--fm);font-size:11px;letter-spacing:1px;color:var(--txd);line-height:1.8;}
.paste-hint strong{color:var(--gl);}

/* done screen */
.done-icon{font-size:60px;text-align:center;margin-bottom:16px;filter:drop-shadow(0 0 20px rgba(78,100,67,0.5));}
.done-links{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:20px;}
.done-link{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;
  background:rgba(78,100,67,0.08);border:1px solid var(--b);text-decoration:none;
  color:var(--tx);transition:all .2s;cursor:pointer;}
.done-link:hover{border-color:var(--g);background:rgba(78,100,67,0.14);}
.done-link-ico{font-size:24px;}
.done-link-lbl{font-family:var(--ff);font-size:15px;letter-spacing:2px;color:var(--gl);}
.done-link-sub{font-family:var(--fm);font-size:9px;letter-spacing:2px;color:var(--mt);}

.spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,0.3);
  border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}

/* reset link */
.reset-link{text-align:center;margin-top:30px;font-family:var(--fm);font-size:10px;letter-spacing:2px;color:var(--mt);}
.reset-link a{color:var(--red);cursor:pointer;text-decoration:underline;}

@media(max-width:500px){.fg2{grid-template-columns:1fr;} .done-links{grid-template-columns:1fr;} .btn-row{flex-direction:column;}}
</style>
</head>
<body>
<div class="wrap">

  <div class="setup-header">
    <img class="setup-logo" src="DM_2.png" alt="DM" onerror="this.style.display='none'">
    <div class="setup-brand">
      <div class="setup-org">DONZO MILITIA</div>
      <div class="setup-sub">// First-time setup wizard</div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="progress" id="progress">
    <div class="step-dot active" id="pd-1"><div class="dot-circle">1</div><div class="dot-label">Firebase</div></div>
    <div class="step-dot"        id="pd-2"><div class="dot-circle">2</div><div class="dot-label">Connect</div></div>
    <div class="step-dot"        id="pd-3"><div class="dot-circle">3</div><div class="dot-label">Admin</div></div>
    <div class="step-dot"        id="pd-4"><div class="dot-circle">4</div><div class="dot-label">Done</div></div>
  </div>

  <!-- STEP 1: Firebase instructions + paste config -->
  <div class="panel active" id="step-1">
    <div class="panel-title">STEP 1 ‚Äî FIREBASE SETUP</div>
    <div class="panel-desc">
      Firebase is the free database that stores your markers and users in real-time.
      Follow these steps to create yours ‚Äî it takes about 5 minutes.
    </div>

    <div class="inst-box">
      <div class="inst-step">
        <div class="inst-n">1</div>
        <div class="inst-t">Go to <strong><a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></strong> and sign in with a Google account.</div>
      </div>
      <div class="inst-step">
        <div class="inst-n">2</div>
        <div class="inst-t">Click <strong>"Add project"</strong>, name it anything (e.g. <code>donzo-militia</code>), turn off Google Analytics, and click <strong>"Create project"</strong>.</div>
      </div>
      <div class="inst-step">
        <div class="inst-n">3</div>
        <div class="inst-t">In the left sidebar click <strong>"Firestore Database"</strong> ‚Üí <strong>"Create database"</strong> ‚Üí choose <strong>"Start in test mode"</strong> ‚Üí pick any region ‚Üí <strong>"Enable"</strong>.</div>
      </div>
      <div class="inst-step">
        <div class="inst-n">4</div>
        <div class="inst-t">Go back to the project home. Click the <strong>&lt;/&gt; (Web)</strong> icon. Name the app anything ‚Üí <strong>"Register app"</strong>. You'll see a code block with <code>firebaseConfig</code> ‚Äî copy it all.</div>
      </div>
      <div class="inst-step">
        <div class="inst-n">5</div>
        <div class="inst-t">Paste the entire code block below. It looks like: <code>const firebaseConfig = { apiKey: "...", ... }</code></div>
      </div>
    </div>

    <label>// Paste your Firebase config here</label>
    <textarea id="config-paste" placeholder='Paste the entire firebaseConfig block here, for example:

const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "your-app.firebaseapp.com",
  projectId: "your-app",
  storageBucket: "your-app.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123:web:abc123"
};'></textarea>

    <div class="status-box" id="s1-status"></div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="step1Next()">NEXT ‚Äî TEST CONNECTION</button>
    </div>
  </div>

  <!-- STEP 2: Test connection -->
  <div class="panel" id="step-2">
    <div class="panel-title">STEP 2 ‚Äî TESTING CONNECTION</div>
    <div class="panel-desc">Connecting to Firebase and verifying your database is accessible...</div>
    <div class="status-box info show" id="s2-status">// Connecting...</div>
    <div class="btn-row" id="s2-btns" style="display:none">
      <button class="btn btn-ghost" onclick="goStep(1)">‚Üê Back</button>
      <button class="btn btn-primary" onclick="goStep(3)">NEXT ‚Äî CREATE ADMIN</button>
    </div>
  </div>

  <!-- STEP 3: Create first Commander -->
  <div class="panel" id="step-3">
    <div class="panel-title">STEP 3 ‚Äî CREATE COMMANDER</div>
    <div class="panel-desc">
      Create the first Commander account. This will be your main admin login.
      You can add more users from within the app later.
    </div>

    <div class="fg2">
      <div>
        <label>// Username (login name)</label>
        <input type="text" id="a-user" placeholder="e.g. commander" autocapitalize="none" autocomplete="off">
      </div>
      <div>
        <label>// Display Name</label>
        <input type="text" id="a-display" placeholder="e.g. Big Boss">
      </div>
    </div>
    <label>// Password</label>
    <input type="password" id="a-pass" placeholder="Choose a strong password">
    <label>// Confirm Password</label>
    <input type="password" id="a-pass2" placeholder="Repeat password">

    <div class="status-box" id="s3-status"></div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goStep(1)">‚Üê Back</button>
      <button class="btn btn-primary" id="s3-btn" onclick="step3Create()">CREATE ACCOUNT & FINISH</button>
    </div>
  </div>

  <!-- STEP 4: Done -->
  <div class="panel" id="step-4">
    <div class="done-icon">‚úÖ</div>
    <div class="panel-title" style="text-align:center">SETUP COMPLETE</div>
    <div class="panel-desc" style="text-align:center;margin-bottom:10px;">
      Donzo Militia is ready. Your database is live and synced across all devices.
    </div>

    <div class="status-box ok show" id="s4-status">// All systems operational</div>

    <div class="done-links">
      <a class="done-link" href="index.html">
        <span class="done-link-ico">üîê</span>
        <span class="done-link-lbl">LOGIN</span>
        <span class="done-link-sub">// Go to login page</span>
      </a>
      <a class="done-link" href="map.html">
        <span class="done-link-ico">üó∫Ô∏è</span>
        <span class="done-link-lbl">MAP</span>
        <span class="done-link-sub">// Open the map</span>
      </a>
      <a class="done-link" href="instructions.html">
        <span class="done-link-ico">üìñ</span>
        <span class="done-link-lbl">GUIDE</span>
        <span class="done-link-sub">// How to use</span>
      </a>
    </div>
  </div>

  <div class="reset-link">
    Already set up? <a onclick="goToLogin()">Go to login</a> &nbsp;|&nbsp;
    <a onclick="resetSetup()">Reset &amp; start over</a>
  </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
let parsedConfig = null;
let firebaseReady = false;
let currentStep = 1;

// If already configured, just go to login
window.onload = function() {
  try {
    const saved = localStorage.getItem('dm_firebase_config');
    if (saved) {
      const cfg = JSON.parse(saved);
      if (cfg && cfg.apiKey) {
        // Pre-fill the textarea for reference but don't auto-skip
        document.getElementById('config-paste').value =
          `const firebaseConfig = ${JSON.stringify(cfg, null, 2)};`;
      }
    }
  } catch {}
};

// ‚îÄ‚îÄ STEP 1: Parse config ‚îÄ‚îÄ
function step1Next() {
  const raw = document.getElementById('config-paste').value.trim();
  const status = document.getElementById('s1-status');

  if (!raw) {
    showStatus(status, 'err', '// Please paste your Firebase config above');
    return;
  }

  // Extract the object from the pasted code
  let cfgObj = null;
  try {
    // Try to extract JSON object from the firebaseConfig assignment or just the object
    let cleaned = raw;
    // Remove 'const firebaseConfig = ' and trailing semicolons/spaces
    cleaned = cleaned.replace(/const\s+firebaseConfig\s*=\s*/, '');
    cleaned = cleaned.replace(/var\s+firebaseConfig\s*=\s*/, '');
    cleaned = cleaned.replace(/let\s+firebaseConfig\s*=\s*/, '');
    cleaned = cleaned.replace(/;\s*$/, '').trim();
    // Remove any trailing code after the closing brace
    const lastBrace = cleaned.lastIndexOf('}');
    if (lastBrace !== -1) cleaned = cleaned.substring(0, lastBrace + 1);
    cfgObj = JSON.parse(cleaned);
  } catch(e) {
    // Try eval as fallback (safe here since user pasted their own code)
    try {
      const fn = new Function('return (' + raw.replace(/const\s+\w+\s*=\s*/,'') + ')');
      cfgObj = fn();
    } catch(e2) {
      showStatus(status, 'err', '// Could not read the config. Make sure you pasted the entire firebaseConfig block.');
      return;
    }
  }

  if (!cfgObj || !cfgObj.apiKey || !cfgObj.projectId) {
    showStatus(status, 'err', '// Config is missing required fields (apiKey, projectId). Please paste the full config block.');
    return;
  }

  parsedConfig = cfgObj;
  showStatus(status, 'ok', '‚úì Config looks good ‚Äî testing connection...');

  // Move to step 2 and test
  setTimeout(() => goStep(2), 800);
}

// ‚îÄ‚îÄ STEP 2: Test Firebase connection ‚îÄ‚îÄ
async function testConnection() {
  const status = document.getElementById('s2-status');
  showStatus(status, 'info', '// Connecting to Firebase...');

  try {
    // Init or re-init Firebase
    if (firebase.apps.length) {
      await firebase.app().delete();
    }
    firebase.initializeApp(parsedConfig);
    const testDb = firebase.firestore();

    showStatus(status, 'info', '// Connected ‚Äî testing database read...');

    // Try a lightweight read
    await testDb.collection('_setup_test').limit(1).get();

    showStatus(status, 'ok', '‚úì Firebase connected successfully! Database is accessible.');
    firebaseReady = true;

    // Save config
    localStorage.setItem('dm_firebase_config', JSON.stringify(parsedConfig));

    // Check if Commander already exists
    const usersSnap = await testDb.collection('users').limit(1).get();
    if (!usersSnap.empty) {
      showStatus(status, 'ok', '‚úì Connected ‚Äî users already exist. You can go straight to login!');
      document.getElementById('s2-btns').innerHTML = `
        <button class="btn btn-ghost" onclick="goStep(1)">‚Üê Back</button>
        <button class="btn btn-primary" onclick="goStep(3)">ADD ANOTHER USER</button>
        <a href="index.html" class="btn btn-primary" style="text-decoration:none;display:inline-block;">GO TO LOGIN ‚Üí</a>`;
    }

    document.getElementById('s2-btns').style.display = 'flex';

  } catch(err) {
    let msg = err.message || 'Unknown error';
    if (msg.includes('invalid-api-key') || msg.includes('api-key')) {
      msg = 'Invalid API key ‚Äî make sure you copied the full config from Firebase console.';
    } else if (msg.includes('network') || msg.includes('fetch')) {
      msg = 'Network error ‚Äî check your internet connection and try again.';
    }
    showStatus(status, 'err', '// CONNECTION FAILED: ' + msg);
    document.getElementById('s2-btns').innerHTML = `<button class="btn btn-ghost" onclick="goStep(1)">‚Üê Back & Fix Config</button>`;
    document.getElementById('s2-btns').style.display = 'flex';
  }
}

// ‚îÄ‚îÄ STEP 3: Create Commander account ‚îÄ‚îÄ
async function step3Create() {
  const username    = document.getElementById('a-user').value.trim().toLowerCase();
  const displayName = document.getElementById('a-display').value.trim();
  const password    = document.getElementById('a-pass').value;
  const password2   = document.getElementById('a-pass2').value;
  const status      = document.getElementById('s3-status');
  const btn         = document.getElementById('s3-btn');

  if (!username || !password) { showStatus(status, 'err', '// Username and password are required'); return; }
  if (username.length < 3)    { showStatus(status, 'err', '// Username must be at least 3 characters'); return; }
  if (password.length < 6)    { showStatus(status, 'err', '// Password must be at least 6 characters'); return; }
  if (password !== password2) { showStatus(status, 'err', '// Passwords do not match'); return; }
  if (/\s/.test(username))    { showStatus(status, 'err', '// Username cannot contain spaces'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>CREATING...';

  try {
    // Ensure Firebase is ready
    if (!firebase.apps.length) {
      firebase.initializeApp(parsedConfig);
    }
    const testDb = firebase.firestore();

    // Check if username taken
    const existing = await testDb.collection('users').where('username','==',username).get();
    if (!existing.empty) {
      showStatus(status, 'err', '// That username already exists ‚Äî choose another or go to login');
      btn.disabled = false; btn.textContent = 'CREATE ACCOUNT & FINISH';
      return;
    }

    // Create user
    await testDb.collection('users').add({
      username,
      password,
      displayName: displayName || username,
      accessLevel: 4,
      createdBy: 'setup_wizard',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showStatus(status, 'ok', `‚úì Commander account "${username}" created successfully!`);
    setTimeout(() => goStep(4), 900);

  } catch(err) {
    showStatus(status, 'err', '// Error: ' + err.message);
    btn.disabled = false; btn.textContent = 'CREATE ACCOUNT & FINISH';
  }
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function goStep(n) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('step-' + n).classList.add('active');

  for (let i = 1; i <= 4; i++) {
    const dot = document.getElementById('pd-' + i);
    dot.classList.remove('active','done');
    if (i < n)  dot.classList.add('done');
    if (i === n) dot.classList.add('active');
  }
  // Check ‚úì on done dots
  document.querySelectorAll('.step-dot.done .dot-circle').forEach(d => { if (!d.textContent.includes('‚úì')) d.textContent = '‚úì'; });

  currentStep = n;
  window.scrollTo(0, 0);

  if (n === 2) {
    document.getElementById('s2-btns').style.display = 'none';
    setTimeout(testConnection, 400);
  }
}

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ
function showStatus(el, type, msg) {
  el.className = 'status-box ' + type + ' show';
  el.textContent = msg;
}

function goToLogin() { window.location.href = 'index.html'; }

function resetSetup() {
  if (!confirm('This will clear your saved Firebase config and require re-setup. Continue?')) return;
  localStorage.removeItem('dm_firebase_config');
  location.reload();
}
</script>
</body>
</html>
