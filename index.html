<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Donzo Militia â€” Login</title>
<link rel="icon" href="DM_2.png">
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/login.css">
</head>
<body class="login-page">

<div class="login-bg-grid"></div>
<div class="login-scan-line"></div>
<div class="login-corner tl"></div>
<div class="login-corner tr"></div>
<div class="login-corner bl"></div>
<div class="login-corner br"></div>

<div class="login-box">

  <div class="login-header">
    <img class="login-logo-img" src="DM_2.png" alt="DM Logo"
         onerror="this.style.display='none'">
    <div class="login-brand-text">
      <div class="login-org-name">DONZO MILITIA</div>
      <div class="login-org-sub">GTA V Operations Database</div>
    </div>
  </div>

  <div class="login-body">
    <div class="login-tabs" id="login-tabs">
      <button class="login-tab active" onclick="window.selectTab(this, 'standard')">Standard Login</button>
      <button class="login-tab"        onclick="window.selectTab(this, 'guest')">Guest View</button>
    </div>

    <form class="login-form" onsubmit="event.preventDefault(); window.doLogin()">
      <div class="form-group">
        <label>// Callsign</label>
        <input type="text" id="login-user"
               placeholder="Enter username..."
               autocomplete="off" autocapitalize="none">
      </div>
      <div class="form-group" id="pass-group">
        <label>// Password</label>
        <input type="password" id="login-pass" placeholder="Enter password...">
      </div>
      <button type="submit" class="btn-primary login-submit-btn" id="login-btn">
        GAIN ACCESS
      </button>
    </form>

    <div class="login-error" id="login-error"></div>
  </div>

  <div class="login-footer">
    <span>// SECURE CONNECTION</span>
    <span>DONZO MILITIA v2.0</span>
  </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- App scripts -->
<script src="js/config.js"></script>
<script src="js/auth.js"></script>

<script>
  // If already logged in, redirect to map
  if (DM.auth.getCurrentUser()) {
    window.location.href = 'map.html';
  }

  window.selectTab = function(btn, mode) {
    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    const passGroup = document.getElementById('pass-group');
    const loginBtn  = document.getElementById('login-btn');
    if (mode === 'guest') {
      passGroup.style.display = 'none';
      loginBtn.textContent = 'ENTER AS GUEST';
    } else {
      passGroup.style.display = '';
      loginBtn.textContent = 'GAIN ACCESS';
    }
    window._loginMode = mode;
  };

  window._loginMode = 'standard';

  window.doLogin = async function() {
    const errEl = document.getElementById('login-error');
    const btn   = document.getElementById('login-btn');
    errEl.textContent = '';

    if (window._loginMode === 'guest') {
      // Guest: level 1 read-only, no DB check
      const guestUser = {
        id: 'guest', username: 'guest',
        displayName: 'Guest',
        accessLevel: 1, levelName: 'Recruit',
        levelColor: '#8a9a7a', levelBg: 'rgba(138,154,122,0.15)',
        canAddMarkers: false, canDeleteOwn: false, canDeleteAll: false
      };
      sessionStorage.setItem('dm_session', JSON.stringify(guestUser));
      window.location.href = 'map.html';
      return;
    }

    const username = document.getElementById('login-user').value;
    const password = document.getElementById('login-pass').value;

    if (!username || !password) {
      errEl.textContent = '// USERNAME AND PASSWORD REQUIRED';
      return;
    }

    btn.textContent = 'AUTHENTICATING...';
    btn.disabled = true;

    const result = await DM.auth.login(username, password);

    if (result.success) {
      window.location.href = 'map.html';
    } else {
      errEl.textContent = '// ' + result.error;
      btn.textContent = 'GAIN ACCESS';
      btn.disabled = false;
    }
  };
</script>
</body>
</html>
